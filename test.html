<!doctype html>
<html>
    <head>
        <title>WebRTC P2P Chat</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            textarea {
                width: 100%;
                height: 80px;
                margin: 10px 0;
            }
            button {
                padding: 8px 15px;
                margin: 5px;
            }
            .section {
                border: 1px solid #ccc;
                padding: 15px;
                margin: 10px 0;
            }
            #messages {
                height: 200px;
                overflow-y: scroll;
                border: 1px solid #ccc;
                padding: 10px;
                margin: 10px 0;
            }
            .message {
                margin: 5px 0;
            }
            .sent {
                text-align: right;
                color: blue;
            }
            .received {
                text-align: left;
                color: green;
            }
        </style>
    </head>
    <body>
        <h1>WebRTC P2P Chat</h1>
        <div id="status">Status: Disconnected</div>

        <div class="section">
            <h3>Step 1: Setup</h3>
            <button onclick="createOffer()">Create Offer (Device A)</button>
            <button onclick="showAnswerSection()">
                Accept Offer (Device B)
            </button>

            <div id="offerSection" style="display: none">
                <h4>Send this offer to other device:</h4>
                <textarea id="offerDisplay" readonly></textarea>
            </div>

            <div id="answerSection" style="display: none">
                <h4>Paste offer here:</h4>
                <textarea id="offerInput"></textarea>
                <button onclick="acceptOffer()">Create Answer</button>

                <div id="answerOutput" style="display: none">
                    <h4>Send this answer back:</h4>
                    <textarea id="answerDisplay" readonly></textarea>
                </div>
            </div>

            <div id="finalSection" style="display: none">
                <h4>Paste answer here:</h4>
                <textarea id="answerInput"></textarea>
                <button onclick="acceptAnswer()">Complete Setup</button>
            </div>
        </div>

        <div id="syncSection" style="display: none" class="section">
            <h3>Step 2: Connect</h3>
            <p>Both devices click Start Connection at the same time:</p>
            <button id="startBtn" onclick="startConnection()">
                Start Connection
            </button>
        </div>

        <div class="section">
            <h3>Chat</h3>
            <div id="messages"></div>
            <input type="text" id="messageInput" disabled />
            <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
        </div>

        <script>
            let pc = null;
            let dataChannel = null;
            let isOfferer = false;
            let iceCandidates = [];

            function log(msg) {
                console.log(msg);
                document.getElementById("status").textContent =
                    "Status: " + msg;
            }

            function addMessage(msg, sent) {
                const div = document.createElement("div");
                div.className = "message " + (sent ? "sent" : "received");
                div.textContent = (sent ? "You: " : "Other: ") + msg;
                document.getElementById("messages").appendChild(div);
                document.getElementById("messages").scrollTop =
                    document.getElementById("messages").scrollHeight;
            }

            function initPeerConnection() {
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.atagverwarming.nl:3478" }],
                });

                iceCandidates = [];

                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        iceCandidates.push(event.candidate);
                    }
                };

                pc.onconnectionstatechange = () => {
                    log(pc.connectionState);
                    if (pc.connectionState === "connected") {
                        document.getElementById("messageInput").disabled =
                            false;
                        document.getElementById("sendBtn").disabled = false;
                        document.getElementById("startBtn").style.display =
                            "none";
                    }
                };

                pc.ondatachannel = (event) => {
                    setupDataChannel(event.channel);
                };
            }

            function setupDataChannel(channel) {
                dataChannel = channel;
                dataChannel.onmessage = (event) => {
                    addMessage(event.data, false);
                };
            }

            async function createOffer() {
                initPeerConnection();
                isOfferer = true;

                dataChannel = pc.createDataChannel("chat");
                setupDataChannel(dataChannel);

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await waitForIce();

                const data = {
                    type: pc.localDescription.type,
                    sdp: pc.localDescription.sdp,
                    candidates: iceCandidates,
                };

                document.getElementById("offerDisplay").value =
                    JSON.stringify(data);
                document.getElementById("offerSection").style.display = "block";
                document.getElementById("finalSection").style.display = "block";
                log("Offer created");
            }

            function showAnswerSection() {
                document.getElementById("answerSection").style.display =
                    "block";
            }

            async function acceptOffer() {
                const input = document
                    .getElementById("offerInput")
                    .value.trim();
                if (!input) return;

                const data = JSON.parse(input);

                initPeerConnection();

                await pc.setRemoteDescription(
                    new RTCSessionDescription({
                        type: data.type,
                        sdp: data.sdp,
                    }),
                );

                for (const candidate of data.candidates) {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                }

                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await waitForIce();

                const answerData = {
                    type: pc.localDescription.type,
                    sdp: pc.localDescription.sdp,
                    candidates: iceCandidates,
                };

                document.getElementById("answerDisplay").value =
                    JSON.stringify(answerData);
                document.getElementById("answerOutput").style.display = "block";
                document.getElementById("syncSection").style.display = "block";
                log("Answer created");
            }

            async function acceptAnswer() {
                const input = document
                    .getElementById("answerInput")
                    .value.trim();
                if (!input) return;

                const data = JSON.parse(input);

                await pc.setRemoteDescription(
                    new RTCSessionDescription({
                        type: data.type,
                        sdp: data.sdp,
                    }),
                );

                for (const candidate of data.candidates) {
                    await pc.addIceCandidate(new RTCIceCandidate(candidate));
                }

                document.getElementById("syncSection").style.display = "block";
                log("Setup complete");
            }

            function startConnection() {
                document.getElementById("startBtn").disabled = true;
                log("Connecting...");
            }

            function waitForIce() {
                return new Promise((resolve) => {
                    if (pc.iceGatheringState === "complete") {
                        resolve();
                        return;
                    }

                    const timeout = setTimeout(() => {
                        resolve();
                    }, 5000);

                    const checkState = () => {
                        if (pc.iceGatheringState === "complete") {
                            clearTimeout(timeout);
                            pc.removeEventListener(
                                "icegatheringstatechange",
                                checkState,
                            );
                            resolve();
                        }
                    };

                    pc.addEventListener("icegatheringstatechange", checkState);
                });
            }

            function sendMessage() {
                const input = document.getElementById("messageInput");
                const message = input.value.trim();
                if (
                    !message ||
                    !dataChannel ||
                    dataChannel.readyState !== "open"
                )
                    return;

                dataChannel.send(message);
                addMessage(message, true);
                input.value = "";
            }

            document
                .getElementById("messageInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") sendMessage();
                });
        </script>
    </body>
</html>
