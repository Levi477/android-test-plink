<!doctype html>
<html>
    <head>
        <title>WebRTC P2P Chat</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            textarea {
                width: 100%;
                height: 100px;
                margin: 10px 0;
            }
            button {
                padding: 10px;
                margin: 5px;
            }
            .section {
                border: 1px solid #ccc;
                padding: 15px;
                margin: 10px 0;
            }
            #messages {
                height: 200px;
                overflow-y: scroll;
                border: 1px solid #ccc;
                padding: 10px;
            }
            .message {
                margin: 5px 0;
            }
            .sent {
                text-align: right;
                color: blue;
            }
            .received {
                text-align: left;
                color: green;
            }
        </style>
    </head>
    <body>
        <h1>WebRTC P2P Chat</h1>

        <div id="status">Status: Disconnected</div>

        <div class="section">
            <h3>Connection Setup</h3>
            <button onclick="createOffer()">1. Create Offer (Device A)</button>
            <button onclick="showAnswerSection()">
                2. I have an offer (Device B)
            </button>

            <div id="offerSection" style="display: none">
                <h4>Your Offer - Send this to the other device:</h4>
                <textarea id="offerDisplay" readonly></textarea>
                <button onclick="copyText('offerDisplay')">Copy Offer</button>
            </div>

            <div id="answerSection" style="display: none">
                <h4>Paste the offer you received here:</h4>
                <textarea
                    id="offerInput"
                    placeholder="Paste offer here..."
                ></textarea>
                <button onclick="acceptOffer()">
                    Accept Offer & Create Answer
                </button>

                <div id="answerOutput" style="display: none">
                    <h4>Your Answer - Send this back:</h4>
                    <textarea id="answerDisplay" readonly></textarea>
                    <button onclick="copyText('answerDisplay')">
                        Copy Answer
                    </button>
                </div>
            </div>

            <div id="finalSection" style="display: none">
                <h4>Paste the answer you received here:</h4>
                <textarea
                    id="answerInput"
                    placeholder="Paste answer here..."
                ></textarea>
                <button onclick="acceptAnswer()">Complete Connection</button>
            </div>
        </div>

        <div class="section">
            <h3>Chat</h3>
            <div id="messages"></div>
            <input
                type="text"
                id="messageInput"
                placeholder="Type message..."
                disabled
            />
            <button onclick="sendMessage()" id="sendBtn" disabled>Send</button>
        </div>

        <script>
            let pc = null;
            let dataChannel = null;
            let isOfferer = false;

            function log(msg) {
                console.log(msg);
                document.getElementById("status").textContent =
                    "Status: " + msg;
            }

            function addMessage(msg, sent) {
                const div = document.createElement("div");
                div.className = "message " + (sent ? "sent" : "received");
                div.textContent = (sent ? "You: " : "Peer: ") + msg;
                document.getElementById("messages").appendChild(div);
                document.getElementById("messages").scrollTop =
                    document.getElementById("messages").scrollHeight;
            }

            function initPeerConnection() {
                pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: "stun:stun.l.google.com:19302" },
                        { urls: "stun:stun1.l.google.com:19302" },
                    ],
                });

                pc.onicecandidate = (event) => {
                    console.log("ICE candidate:", event.candidate);
                };

                pc.onconnectionstatechange = () => {
                    log("Connection state: " + pc.connectionState);
                };

                pc.ondatachannel = (event) => {
                    const channel = event.channel;
                    setupDataChannel(channel);
                    log("Data channel received");
                };
            }

            function setupDataChannel(channel) {
                dataChannel = channel;

                dataChannel.onopen = () => {
                    log("Connected! You can now chat.");
                    document.getElementById("messageInput").disabled = false;
                    document.getElementById("sendBtn").disabled = false;
                };

                dataChannel.onmessage = (event) => {
                    addMessage(event.data, false);
                };

                dataChannel.onclose = () => {
                    log("Connection closed");
                    document.getElementById("messageInput").disabled = true;
                    document.getElementById("sendBtn").disabled = true;
                };

                dataChannel.onerror = (error) => {
                    log("Data channel error: " + error);
                };
            }

            async function createOffer() {
                try {
                    initPeerConnection();
                    isOfferer = true;

                    // Create data channel
                    dataChannel = pc.createDataChannel("chat");
                    setupDataChannel(dataChannel);

                    log("Creating offer...");

                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    // Wait for ICE gathering
                    await waitForIceGathering();

                    const offerObj = {
                        type: pc.localDescription.type,
                        sdp: pc.localDescription.sdp,
                    };

                    document.getElementById("offerDisplay").value =
                        JSON.stringify(offerObj);
                    document.getElementById("offerSection").style.display =
                        "block";
                    document.getElementById("finalSection").style.display =
                        "block";

                    log("Offer created. Send it to the other device.");
                } catch (error) {
                    log("Error creating offer: " + error.message);
                    console.error("Offer error:", error);
                }
            }

            function showAnswerSection() {
                document.getElementById("answerSection").style.display =
                    "block";
            }

            async function acceptOffer() {
                try {
                    const offerText = document
                        .getElementById("offerInput")
                        .value.trim();
                    if (!offerText) {
                        alert("Please paste an offer first");
                        return;
                    }

                    let offerObj;
                    try {
                        offerObj = JSON.parse(offerText);
                    } catch (e) {
                        alert("Invalid JSON format");
                        return;
                    }

                    if (!offerObj.type || !offerObj.sdp) {
                        alert("Invalid offer format - missing type or sdp");
                        return;
                    }

                    initPeerConnection();

                    log("Processing offer...");

                    await pc.setRemoteDescription(
                        new RTCSessionDescription(offerObj),
                    );

                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    // Wait for ICE gathering
                    await waitForIceGathering();

                    const answerObj = {
                        type: pc.localDescription.type,
                        sdp: pc.localDescription.sdp,
                    };

                    document.getElementById("answerDisplay").value =
                        JSON.stringify(answerObj);
                    document.getElementById("answerOutput").style.display =
                        "block";

                    log("Answer created. Send it back to the other device.");
                } catch (error) {
                    log("Error accepting offer: " + error.message);
                    console.error("Accept offer error:", error);
                }
            }

            async function acceptAnswer() {
                try {
                    const answerText = document
                        .getElementById("answerInput")
                        .value.trim();
                    if (!answerText) {
                        alert("Please paste an answer first");
                        return;
                    }

                    let answerObj;
                    try {
                        answerObj = JSON.parse(answerText);
                    } catch (e) {
                        alert("Invalid JSON format");
                        return;
                    }

                    if (!answerObj.type || !answerObj.sdp) {
                        alert("Invalid answer format - missing type or sdp");
                        return;
                    }

                    log("Processing answer...");

                    await pc.setRemoteDescription(
                        new RTCSessionDescription(answerObj),
                    );

                    log("Connection setup complete. Waiting for connection...");
                } catch (error) {
                    log("Error accepting answer: " + error.message);
                    console.error("Accept answer error:", error);
                }
            }

            function waitForIceGathering() {
                return new Promise((resolve) => {
                    if (pc.iceGatheringState === "complete") {
                        resolve();
                    } else {
                        const checkState = () => {
                            if (pc.iceGatheringState === "complete") {
                                pc.removeEventListener(
                                    "icegatheringstatechange",
                                    checkState,
                                );
                                resolve();
                            }
                        };
                        pc.addEventListener(
                            "icegatheringstatechange",
                            checkState,
                        );

                        // Fallback timeout
                        setTimeout(() => {
                            pc.removeEventListener(
                                "icegatheringstatechange",
                                checkState,
                            );
                            resolve();
                        }, 3000);
                    }
                });
            }

            function sendMessage() {
                const input = document.getElementById("messageInput");
                const message = input.value.trim();

                if (!message) return;

                if (dataChannel && dataChannel.readyState === "open") {
                    dataChannel.send(message);
                    addMessage(message, true);
                    input.value = "";
                } else {
                    log("Connection not ready");
                }
            }

            function copyText(elementId) {
                const element = document.getElementById(elementId);
                element.select();
                element.setSelectionRange(0, 99999);
                document.execCommand("copy");
                alert("Copied to clipboard!");
            }

            // Handle Enter key in message input
            document
                .getElementById("messageInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        sendMessage();
                    }
                });

            // Debug logging
            window.onerror = (msg, url, line, col, error) => {
                console.error("Error:", msg, "at", line + ":" + col);
                log("JavaScript error occurred - check console");
            };
        </script>
    </body>
</html>
